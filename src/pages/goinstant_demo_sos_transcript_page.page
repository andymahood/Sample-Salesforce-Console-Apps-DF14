<apex:page showHeader="false" standardStylesheets="false">

    <script type="text/javascript">
        var Keen=Keen||{configure:function(e){this._cf=e},addEvent:function(e,t,n,i){this._eq=this._eq||[],this._eq.push([e,t,n,i])},setGlobalProperties:function(e){this._gp=e},onChartsReady:function(e){this._ocrq=this._ocrq||[],this._ocrq.push(e)}};(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://":"http://")+"dc8na2hxrj29i.cloudfront.net/code/keen-2.1.0-min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();

        // Configure the Keen object with your Project ID and (optional) access keys.
        Keen.configure({
            projectId: "530d2072d97b85424c000005",
            writeKey: "c4b675b536c234567cb31ca2634bbc8cf7a7de5c718d080a4c2afceac8abcdcc6ee32fec239fde6071eadda1d20bebaf6dcde137f10a9f62cd8354ad639e09da3008a75ff03f186a2d1b7459b26e968cb6941b66b8424b06bd45800219a0ea411e0e1dc75dec01f8d2992e2e1a4f0e6e"
        });
    </script>

    <style>
        .icon {
            background: url({!HTMLENCODE($Resource.sos_end_sprite)}) no-repeat;
        }
    </style>

	<apex:stylesheet value="{!HTMLENCODE($Resource.goinstant_sos_transcript_css)}" />

	<apex:includeScript value="{!HTMLENCODE($Resource.goinstant_sos_jquery)}"/>
	<apex:includeScript value="/support/console/29.0/integration.js" />
    <apex:includeScript value="/js/functions.js" />
    <apex:includeScript value="/soap/ajax/29.0/connection.js" />

    <apex:includeScript value="https://cdn.goinstant.net/v1/platform.min.js" />
    <apex:includeScript value="{!HTMLENCODE($Resource.goinstantVF)}"/>

    <apex:includeScript value="{!HTMLENCODE($Resource.goinstant_sos_transcript_script)}" />

    <script>
        $(function() {
            $(document).bind('GOINSTANT_CONNECTED', function() {
                goVF.rooms.giLobby.self().key('activeSession').remove();
                goVF.rooms.giLobby.leave(function(err) {
                    if (err) {
                        console.log('error leaving room: ', err);
                    }
                });
            });

            var goVF = new goinstantVF({
                connectUrl: '{!JSENCODE($Setup.goinstant_demo_sos_settings__c.connectUrl__c)}',
                debugLevel: 4 // 0 debug | 1 test | 2 info | 3 warn | 4 error
            });
            goVF.connect('sos_agent_room');

            goinstantUtils.getTranscriptData({
                transcriptRoomName: "{!JSENCODE($CurrentPage.parameters.room)}" + '-transcript',
                giConnectUrl: '{!JSENCODE($Setup.goinstant_demo_sos_settings__c.connectUrl__c)}',
                giAccount: '{!JSENCODE($Setup.goinstant_demo_sos_settings__c.connectUrl__c)}'.split('/')[3]
            }, function(err, data) {
                if (err) {
                    console.error(err.message);
                }

                // Set session ID
                sforce.connection.sessionId = '{!JSENCODE($Api.Session_ID)}';

                // Create new GoInstant session object
                var sess = new sforce.SObject("Salesforce_SOS__c");

                var sessDuration = goinstantUtils.getDurationText(data.time.start, new Date().getTime());

                sess.CaseId__c = data.case;
                sess.End_time__c = new Date().toISOString();
                sess.Start_time__c = new Date(data.time.start).toISOString();
                sess.User_IP__c = data.externalIP;
                sess.User_screen_resolution__c = data.resolution.width + 'x' + data.resolution.height;
                sess.Users_in_session__c = data.session_size;
                sess.Session_type__c = 'SOS';
                sess.Duration__c = sessDuration;
                sess.System_info__c = data.type + ' iOS '+ data.os;
                sess.Request_time__c = new Date(data.requestTime).toISOString();
                sess.Wait_time__c = goinstantUtils.getDurationText(data.requestTime, data.time.start);
                sess.Username__c = data.username;
                sess.App_version__c = data.appVersion;
                sess.UserId__c = data.userId;
                sess.ContactId__c = data.contactId;

                // Create session
                var result = sforce.connection.create([sess]);

                // Refresh case
                sforce.console.refreshPrimaryTabById(data.caseTabId);

                $('#caseNumber').text(data.caseNumber);
                $('#sessionLength').text(sessDuration);

                // Log data to Keen.io
                Keen.addEvent("sessionEvent", {
                    startTime: sess.Start_time__c,
                    endTime: sess.End_time__c,
                    duration: sess.Duration__c,
                    appVersion: sess.App_version__c,
                    deviceScreenResolution: sess.User_screen_resolution__c,
                    org: '{!JSENCODE($Organization.Name)}',
                    profileName: '{!JSENCODE($Profile.Name)}',
                    packageVersion: '1.29beta',
                    giAccount: data.giAccount
                });
            });
        });
    </script>

    <apex:pageBlock >
        <h2 class="session-ended"><span class="icon icon-sos"></span> Session Ended</h2>
        <div class="container">
            <div class="status">
                <div class="transcript-saved"><span class="icon icon-transcript"></span> Transcript saved</div>
                <div class="attached-to-case"><span class="icon icon-case"></span> Attached to case: <span id="caseNumber"></span></div>
                <div class="session-duration"><span class="icon icon-time"></span> Session Duration: <span id="sessionLength"></span></div>
            </div>
            <div class="return">
                <a href='#!' onclick="goinstantUtils.returnToQueue(); return false;" class="button">Return to queue</a>
            </div>
        </div>
        <span class="icon icon-sf1-logo"></span>
    </apex:pageBlock>
</apex:page>